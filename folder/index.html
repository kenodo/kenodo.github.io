<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Document</title>
</head>
<body>
    
    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.7.1/pixi.min.js"></script>
<script src="bump.js"></script>
<script src="https://code.createjs.com/soundjs-0.6.2.min.js"></script>

<script>
  let app = new PIXI.Application({ 
    width: 800, 
    height: 600,                       
    antialias: true, 
    transparent: false, 
    resolution: 1,
    backgroundColor:0x51b1cd,
    roundPixels: true
  }
);

//Add the canvas that Pixi automatically created for you to the HTML document
document.body.appendChild(app.view);
    
    var text = new PIXI.Text('Загрузка котанов...',{fill : '#000000', font : '48px Arial',wordWrap : true, wordWrapWidth : 700});
			text.x = 200;
            text.y=230;
			app.stage.addChild(text);
    
    

  var stepSound=createjs.Sound.registerSound("step.mp3", "step");
  console.log(stepSound);
  var treeFallSound=createjs.Sound.registerSound("treefall.mp3", "treeFall");
  console.log(treeFallSound);
  var ambientSound=createjs.Sound.registerSound("ambient.mp3", "ambient");
  console.log(ambientSound);
  var popSound=createjs.Sound.registerSound("pop.mp3", "pop");
  console.log(popSound);
    
//load an image and run the `setup` function when it's done
PIXI.loader
  .add("s.jpg")
  .add("cat.png")
  .add("grass.png")
  .add("snowgrass.png")
  .add("snowtree.png")
  .add("g.png")
  .add("snowg.png")
  .add("tree.png")
  .add("tree2.png")
  .add("tree3.png")
  .add("tree4.png")
  .add("riding.png")
  .add("snowg-resource.png")
  .add("gb.png")
  .add("snowgb.png")
  .add("back.png")
  .add("flower.png")
  .add("cat2.png")
  .add("stone.png")
  .load(setup);
    
PIXI.TRANSFORM_MODE.DEFAULT = PIXI.TRANSFORM_MODE.DYNAMIC;
    



//This `setup` function will run when the image has loaded
function setup() {
    var catRiding;
    var riding=false;
    var fall=false;
    var fallingTrees = [];
    var jumping=false;
    var jumpDisplacement=0;
    
      function fallTree(){
          if(!fall)createjs.Sound.play("treeFall");
          fall=true;
          
               fallingTrees.forEach(function(item,i,arr) {
  item.rotation += 0.02;
  item.y+=0.8;
  if(item.rotation>1.2){
      delete fallingTrees[i];
      fall=false;
  }
});
       } 
    
    
    
    
    
    
    var sand = new Array();
    var myStorageCounter=0;
    var leftBlock = 0;
    var leftY = 256;
    var rightY = 256;
    var rightBlock=0;
    var catY=0;
    let pers = new PIXI.Container();
    let container = new PIXI.Container();
    let tree=new PIXI.Container();
    tree.y=50;
    var treeArr=[];
    let gcontainer=new PIXI.ParticleContainer(15000,0,20000,true);
    var toDelete= [];
    var resArr=[];  
    
  function addTree(genX, Ycoord,biom){
      var treeChance=Math.random()>=0.9;
      if (biom=="forest"){
      treeChance=Math.random()>=0.93;  
      }
      
      var treeType=Math.random();
      if (treeChance){
                let tr;
                let flower = new PIXI.Sprite(PIXI.loader.resources["flower.png"].texture);
                
                if(treeType>=0.3 & treeType<0.5){
                    tr=new PIXI.Sprite(PIXI.loader.resources["tree.png"].texture);
                }
                else if(treeType>=0.5 & treeType<0.7){
                    tr=new PIXI.Sprite(PIXI.loader.resources["tree2.png"].texture);
                }
                else if(treeType>=0.7){
                    tr=new PIXI.Sprite(PIXI.loader.resources["tree3.png"].texture);
                }
                else{
                    tr=new PIXI.Sprite(PIXI.loader.resources["tree4.png"].texture);
                }
              Ycoord+=150;
              tr.width=100;
              tr.height=160;
              tr.y=Ycoord-200;
              flower.y=Ycoord-220;
              flower.width=15;
              flower.height=30;
              flower.x=genX-32;
                
                
              treeArr[genX]=tr;
              treeArr[genX].anchor.set(1);
          
               
          
              treeArr[genX+500]=flower;
              tree.addChild(treeArr[genX]);
            tree.addChild(treeArr[genX+500]);
              treeArr[genX].x=genX;
           treeArr[genX].interactive = true;
                treeArr[genX].click = function(){
                    fallingTrees.push(treeArr[genX]);
                    fallTree();
                }
            }
      
  }
    
 
  
 function addResource(xCoord, yCoord){
    var res=new PIXI.Sprite(PIXI.loader.resources["snowg-resource.png"].texture);
    //res.anchor.set(0.5);
    res.y=yCoord-16;
    res.x=xCoord;
    res.initialY=yCoord;
    res.width=16;
    res.height=16;
    res.jumpDisplacement=0;
    res.jumping=true;
    res.falling=false;
    resArr[xCoord]=res;
    container.addChild(res);
    console.log(resArr);
    app.stage.addChild(container);
     
    jumpRes(res);
 }  
    

  function generateLTR(biom){
    
      let grassSprite=new PIXI.Sprite(PIXI.loader.resources["grass.png"].texture);
      let groundSprite=new PIXI.Sprite(PIXI.loader.resources["g.png"].texture);
      let groundBonesSprite=new PIXI.Sprite(PIXI.loader.resources["gb.png"].texture);  
      
      
          if(biom=="forest"){
             grassSprite=new PIXI.Sprite(PIXI.loader.resources["snowgrass.png"].texture);
             groundSprite=new PIXI.Sprite(PIXI.loader.resources["snowg.png"].texture);
             groundBonesSprite=new PIXI.Sprite(PIXI.loader.resources["snowgb.png"].texture);
          }
            
            
           
      
      
         for(var i=0;i<5;i++){
            var genX=0;
             
      
     
    
       
        
        var randY = 16*Math.round(Math.sin(rightBlock)+20)-(Math.floor(Math.random() * 10))*16;
        
        while(rightY!=randY){
        genX=rightBlock;
        sand[genX] = new Array();
        rightBlock+=16;     
        let sprite=grassSprite;
            
        sand[genX][rightY]=new PIXI.Sprite(sprite.texture);
        
        
            sand[genX][rightY].interactive = true;
        sand[genX][rightY].click = function(e) {
         sand[genX][rightY].visible=false;
         createjs.Sound.play("pop");
         
 }
            
        sand[genX][rightY].x=genX;
        var rightYToAdd=rightY;       
            
        var randbool = Math.random() >= 0.9;
            
        if(rightY<randY){
          addTree(genX,rightY,biom);
          sand[genX][rightY].y=rightY;
          if(randbool)rightY+=16;
        }
        else{
            sand[genX][rightY].y=rightY;
            rightY-=16;
        }
        
                 
        sand[genX][rightYToAdd].width=16;       
        sand[genX][rightYToAdd].height=16;
        container.addChild(sand[genX][rightYToAdd]);
            sand[genX][rightYToAdd].interactive = true;
             sand[genX][rightYToAdd].click = function(e) {
                
                console.log("rightYToAdd clicked");
                this.visible=false;
                createjs.Sound.play("pop");
                addResource(this.x,this.y);
                this.y+=600;
             }
        
            
            
            
            
        toDelete.push(sand[genX][rightYToAdd]);
        
        var toBottomY=rightYToAdd;
        var toStone=0;
            
       while(toBottomY<700){
           
           if(toStone>=8){
                
                sprite = new PIXI.Sprite(PIXI.loader.resources["stone.png"].texture);
                
           }
           else{
               sprite = groundSprite;
               
               var bonesChance = Math.random() >= 0.97;
               
               if (bonesChance){
                 sprite = groundBonesSprite;  
               }
               
           }
           
           
           
            toBottomY+=16;
            sand[genX][toBottomY]= new PIXI.Sprite(sprite.texture);
            
            
           
            sand[genX][toBottomY].x=genX;
            sand[genX][toBottomY].y=toBottomY;
            sand[genX][toBottomY].width=16;       
            sand[genX][toBottomY].height=16;
           
           
          
           
           container.addChild(sand[genX][toBottomY]);
            sand[genX][toBottomY].interactive = true;
            sand[genX][toBottomY].click = function(e) {
                
               console.log("toBottomY clicked");
                this.visible=false;
                createjs.Sound.play("pop");
                addResource(this.x,this.y);
                this.y+=600;
             }
           toStone+=1;
           
        toDelete.push(sand[genX][toBottomY]);
        }
                 
        
             }
        
        
        
    }
    
    app.stage.addChild(gcontainer);
    }
    
    
  function generateRTL(){
       
        var genX=0;
      /*
      
     toDelete.forEach(function(item) {
  item.visible=false;
});
      */
         for(var i=0;i<3;i++){
             
        
        
       
       var randY = 16*Math.round(Math.sin(leftBlock)+20)-(Math.floor(Math.random() * 10))*16;
  
        
      
        
        while(leftY!=randY){
        genX=leftBlock;
        sand[genX] = new Array();
        leftBlock-=16;  
        let sprite=new PIXI.Sprite(PIXI.loader.resources["grass.png"].texture);
        
        sand[genX][leftY]=sprite;
     
        sand[genX][leftY].x=genX;
        var leftYToAdd=leftY;       
        var randbool = Math.random() >= 0.9;
       
            
        if(leftY<randY){
          sand[genX][leftY].y=leftY;
          addTree(genX,leftY);
            
          
        
          if(randbool){
              
              leftY+=16;
            
              
 
          }
        }
        else{
            sand[genX][leftY].y=leftY;
            leftY-=16;
        }
        
                 
        sand[genX][leftYToAdd].width=16;       
        sand[genX][leftYToAdd].height=16;
        container.addChild(sand[genX][leftYToAdd]);
        
        
        
        toDelete.push(sand[genX][leftYToAdd]);
        toBottom();
       
            
            function toBottom(){
                 var toBottomY=leftYToAdd;
        while(toBottomY<700){
            sprite = new PIXI.Sprite(PIXI.loader.resources["g.png"].texture);
            toBottomY+=16;
            sand[genX][toBottomY]=sprite;
           
            sand[genX][toBottomY].x=genX;
            sand[genX][toBottomY].y=toBottomY;
            sand[genX][toBottomY].width=16;       
            sand[genX][toBottomY].height=16;
           container.addChild(sand[genX][toBottomY]);
           
        toDelete.push(sand[genX][toBottomY]);
        }
            }
                 
        
             }
        
        
        
    }
    
   
    
    }
    
    
  function floatGrnd(){
       
        var genX=0;
      /*
      
     toDelete.forEach(function(item) {
  item.visible=false;
});
      */
         for(var i=0;i<200;i++){
             
        genX+=16;
        sand[genX] = new Array();
        
        
       
        var randY = 256;
             
        sand[genX][randY]=sandBlock;
        sand[genX][randY].x=genX;
        sand[genX][randY].y=randY;
        sand[genX][randY].width=16;       
        sand[genX][randY].height=16;
        container.addChild(sand[genX][randY]);
        console.log(sand[genX][randY]);
        console.log("block = " + genX + '|' + randY);
        console.log("coords = " + sand[genX][randY].x + "|" + sand[genX][randY].y);
             console.log('gen');
       
                 
        
             }
    }
    
   
     function addCat(){
       
        var n=2+Math.round(Math.random()*3);
        
        for(var i=1;i<n;i++){
           
    cats[i]=new PIXI.Sprite(PIXI.loader.resources["cat2.png"].texture);
    cats[i].anchor.set(0.5);
    cats[i].y=0;
    cats[i].x=cat.x+(16*(Math.round(Math.random()*20)));
    cats[i].rndx=cats[i].x;
    cats[i].width=60;
    cats[i].height=50;
    container.addChild(cats[i]);
    app.stage.addChild(container);
    cats[i].interactive=true;
    cats[i].falling=true;   

    
    cats[1].click = function(){
        container.x-=cats[1].x-cat.x;
        gcontainer.x-=cats[1].x-cat.x;
                    cat.x=cats[1].x;
                    cat.y=cats[1].y-=16;
                    cats[1].texture=PIXI.loader.resources["riding.png"].texture;
                    cats[1].height+=10;
                    cat.visible=false;
                    riding=true;
                    catRiding=cats[1];
                    //fallTree();
                }  
        }
        
    
    }
    
    
    
    function checkPhysics(arr) {
        
        
        arr.forEach(function(item,i) {
  if(arr[i].falling){
      arr[i].y+=1;
  }
    for(var m=-4;m<=3;m++){
                
                try{
                
                 
                 b = new Bump(PIXI);
                 let catVsBlocks = b.hit(
  arr[i], 
  sand[arr[i].rndx+(m*16)][arr[i].y+16], 
  true, false, false, 
  function(collision, platform){
      
      
      //cat.y-=7;
      
     if(m==-2|m==1){
         
         arr[i].y-=4;
         arr[i].falling=false;
     };
      
  
      
  }
                     
                     
);
                 
                  
               //collide(cat,sand[cat.x][cat.y+64]);
           }   
      catch {
      
  }
            }         
            
  
});     
    
 }
    
    
    
    
    function keyboard(keyCode) {
  let key = {};
  key.code = keyCode;
  key.isDown = false;
  key.isUp = true;
  key.press = undefined;
  key.release = undefined;
  //The `downHandler`
  key.downHandler = event => {
    if (event.keyCode === key.code) {
      if (key.isUp && key.press) key.press();
      key.isDown = true;
      key.isUp = false;
    }
    event.preventDefault();
  };

  //The `upHandler`
  key.upHandler = event => {
    if (event.keyCode === key.code) {
      if (key.isDown && key.release) key.release();
      key.isDown = false;
      key.isUp = true;
    }
    event.preventDefault();
  };

  //Attach event listeners
  window.addEventListener(
    "keydown", key.downHandler.bind(key), false
  );
  window.addEventListener(
    "keyup", key.upHandler.bind(key), false
  );
  return key;
}
    
    
    let left = keyboard(37),
      up = keyboard(38),
      right = keyboard(39),
      down = keyboard(40);
    
    var cats=[];
    pers.y=0;
          
   let backCont = new PIXI.Container();
    var background = new PIXI.Sprite(PIXI.loader.resources["back.png"].texture);
    background.anchor.set(0);
    background.y=0;
    background.x=0;
    background.width=1000;
    background.height=600;
    backCont.addChild(background);
    app.stage.addChild(backCont);
    
          
    cat=new PIXI.Sprite(PIXI.loader.resources["cat.png"].texture);
    cat.anchor.set(0.5);
    cat.y=0;
    container.y=200;
    gcontainer.y=200;
    cat.x=464;
    cat.rndx=464;
    console.log(cat.getGlobalPosition());
    catY=160;
    cat.width=60;
    cat.height=50;
    
    
    container.addChild(cat);
    container.addChild(tree);
    
    //container.addChild(cat);
    app.stage.addChild(container);
    
    
   
    addCat();
    generateRTL();
    generateLTR("forest");
    checkPhysics(cats);
    
    
    
    function checkForEdges(side=""){
        
        
        
        
            
            if (side=="right"){
                
                
                
                
                if(gcontainer.x<((-1*rightBlock)+800)){
                    generateLTR("forest");  
                }
                
               
            }
            else if (side=="left"){
                 if(gcontainer.x>((-1*leftBlock))){
                   generateRTL(); 
                }
            }
           
           
           
        
    }
    
    
    var moveRight=false;
    var moveLeft=false;
    
    right.press = () => {
        moveRight=true;
        catFalling=true;
  };
    
    right.release = () =>{
      moveRight=false;  
      catFalling=true;
    };
    
     left.press = () => {
        moveLeft=true;
  };
    
    left.release = () =>{
      moveLeft=false;  
    };
        
        up.release = () => {
        if(!jumping){
          jumping=true;
        jump();  
        }
        
  };


    app.stage.scale.set(1);
    //container.y=600;
    
  var sandBlock = new PIXI.Sprite(PIXI.loader.resources["s.jpg"].texture); 
  var catFalling=true;
        
        
function jump(){
        
        catFalling=false;
    
        if(jumping){
            cat.y-=(2+jumpDisplacement/2);
            jumpDisplacement+=2;
        }
      
        
        if(jumpDisplacement>15){
            jumping=false;
            catFalling=true;
            jumpDisplacement=0;
        }
    }
        
        
function jumpRes(res){
        
        res.falling=false;
    
        if(res.jumping){
            res.y-=(2+res.jumpDisplacement/2);
            res.jumpDisplacement+=2;
        }
      
        
        if(res.jumpDisplacement>15){
            res.jumping=false;
            res.falling=true;
            res.jumpDisplacement=0;
        }
    }
    
    
    
 function collide() {
     var collideLeft=sand[cat.rndx-16][cat.y];
     var collideRight=sand[cat.rndx+16][cat.y];
     var collideUp=sand[cat.rndx][cat.y];
     var collideBottom=sand[cat.rndx][cat.y+16];
     
     if(!collideBottom)catFalling=true;
     
     
     
     
     b = new Bump(PIXI);
     
     var props = new createjs.PlayPropsConfig().set({interrupt: createjs.Sound.INTERRUPT_ANY, loop: 0, volume: 0.2});
     
     if (collideLeft)
     {
         let cl=b.hit(cat, collideLeft);
         if (cl)
         {cat.y-=16;
          console.log("=======LEFT======");
          catFalling=false;
          createjs.Sound.play("step",props);
         }
     }
     
     if (collideRight)
     {
         let cr=b.hit(cat, collideRight);
         if (cr){
             cat.y-=16;
            console.log("=======RIGHT======");
            catFalling=false;
            
            createjs.Sound.play("step",props);
         }
     }
     if (collideUp)
     {
         let cu=b.hit(cat, collideUp, false);
     }
     if (collideBottom)
     {
         let cb=b.hit(cat, collideBottom, true);
         if (cb){
             catFalling=false;
             cat.y-=1;
             createjs.Sound.play("step",props);
         }
     }
         
       try{
        

        console.log("cl " +cl);
        console.log("cr " +cr);
        console.log("cu " +cu);
        console.log("cb " +cb);
           
       }  
     catch{
         
 }
         
         
        
     
     
     
     /*
      for(var i=-3;i<=2;i++){
                
                try{
                
                 
                 b = new Bump(PIXI);
                 let catVsBlocks = b.hit(
  cat, 
  //sand[464][272], 
  sand[roundedcatX+(i*16)][cat.y+16], 
  true, false, false, 
  function(collision, platform){
      console.log("collide at " + i);
      console.log(collision);
      catFalling=false;
      //cat.y-=7;
      
        
       
          cat.y-=9;
      
         
     
      
      return true;
      
  }
                     
                     
);
                 
                  
               //collide(cat,sand[cat.x][cat.y+64]);
           }   
      catch {
         console.log("block [" + roundedcatX + "]["+cat.y+"]" + "undefined");
         
  }
            }
            
            
*/
     
  
 }
        
          
           
          
           
  var ambientPlaying=false;
         
       
       

  function playAmbient(){
      if(!ambientPlaying){
         console.log("playambient");
         var ambientProps = new createjs.PlayPropsConfig().set({interrupt: createjs.Sound.INTERRUPT_ANY, loop: -1, volume: 0.8});
         if(createjs.Sound.play("ambient",ambientProps)) ambientPlaying=true; 
        
      }
     
  }
         
    
  app.ticker.add(function() {
      
      
         resArr.forEach(function(item,i,arr) {
          if(item.jumping)jumpRes(item);
          else if(item.falling & item.y<item.initialY)item.y+=1;
});
      
         
     
          cat.rndx=Math.floor((cat.x/16))*16;
          if(fall)fallTree();
      
            if(catFalling){
                cat.y+=1;
                collide();
            }
      
            if(jumping)jump();
      
            
      
            checkPhysics(cats);
            
           
            
           
         

      
      
      
         

      
      
     
   
  
      
  if(moveRight){
      
     if(!ambientPlaying)playAmbient();
      
      
      if(riding){
         cat.x+=16;
         cat.y=catRiding.y-16;
         cats[1].falling=true;
         cat.rndx+=16;
         catRiding.x+=16;
         collide();
          container.x-=16;
          gcontainer.x-=16;
          catRiding.scale.x=-0.3;
      }
      else{
      cat.x+=2;
      
      container.x-=2;
      gcontainer.x-=2;
      }
      
      
      
      if ((cat.x%16)==0){
          
          console.log("rndCat++");
          collide();
          
      }
     
      checkForEdges('right');
      cat.scale.x = -0.3;
      
  }
      
     
      
   if(moveLeft){
     
      if(!ambientPlaying)playAmbient();
       
      if(riding){
         //cat.x-=4;
         cat.y=catRiding.y+16;
         cat.rndx-=16;
         catRiding.x-=16;
         collide();
          container.x+=16;
          gcontainer.x+=16;
          catRiding.scale.x=0.3;
      }
      else{
      cat.x-=2;
      
      container.x+=2;
      gcontainer.x+=2;
      }
      
      
      
      if ((cat.x%16)==0){
          console.log("rndCat++");
         // cat.rndx-=16;
          collide();
          
      }
     
      checkForEdges('left');
      cat.scale.x = 0.3;
      
  }
      
      
       
  
  
  
   
});

    
    

}
    
    
    

    
    
    
    
    
    
    </script>
</body>
</html>