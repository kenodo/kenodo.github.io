<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Document</title>
</head>
<body>
    
    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.7.1/pixi.min.js"></script>
<script src="bump.js"></script>

<script>
  let app = new PIXI.Application({ 
    width: 800, 
    height: 600,                       
    antialias: true, 
    transparent: false, 
    resolution: 1,
    backgroundColor:0x51b1cd,
    roundPixels: true
  }
);

//Add the canvas that Pixi automatically created for you to the HTML document
document.body.appendChild(app.view);
    
    var text = new PIXI.Text('Загрузка котанов...',{fill : '#000000', font : '48px Arial',wordWrap : true, wordWrapWidth : 700});
			text.x = 200;
            text.y=230;
			app.stage.addChild(text);

//load an image and run the `setup` function when it's done
PIXI.loader
  .add("s.jpg")
  .add("cat.png")
  .add("grass.png")
  .add("g.png")
  .add("tree.png")
  .add("tree2.png")
  .add("tree3.png")
  .add("tree4.png")
  .add("riding.png")
  .add("back.png")
  .add("flower.png")
  .add("cat2.png")
  .load(setup);
    
PIXI.TRANSFORM_MODE.DEFAULT = PIXI.TRANSFORM_MODE.DYNAMIC;
    



//This `setup` function will run when the image has loaded
function setup() {
    var catRiding;
    var riding=false;
    var fall=false;
    var fallingTrees = [];
    
      function fallTree(){
          fall=true;
               fallingTrees.forEach(function(item,i,arr) {
  item.rotation += 0.02;
  item.y+=0.8;
  if(item.rotation>1.2){
      delete fallingTrees[i];
  }
});
       } 
    
    
    
    var sand = new Array();
    var myStorageCounter=0;
    var leftBlock = 0;
    var leftY = 256;
    var rightY = 256;
    var rightBlock=0;
    var catY=0;
    let pers = new PIXI.Container();
    let container = new PIXI.Container();
    let tree=new PIXI.Container();
    tree.y=50;
    var treeArr=[];
    let gcontainer=new PIXI.ParticleContainer(15000,0,20000,true);
    var toDelete= [];
    
    
  function addTree(genX, Ycoord){
      var treeChance=Math.random()>=0.9;
      var treeType=Math.random();
      if (treeChance){
                let tr;
                let flower = new PIXI.Sprite(PIXI.loader.resources["flower.png"].texture);
                
                if(treeType>=0.3 & treeType<0.5){
                    tr=new PIXI.Sprite(PIXI.loader.resources["tree.png"].texture);
                }
                else if(treeType>=0.5 & treeType<0.7){
                    tr=new PIXI.Sprite(PIXI.loader.resources["tree2.png"].texture);
                }
                else if(treeType>=0.7){
                    tr=new PIXI.Sprite(PIXI.loader.resources["tree3.png"].texture);
                }
                else{
                    tr=new PIXI.Sprite(PIXI.loader.resources["tree4.png"].texture);
                }
              Ycoord+=150;
              tr.width=100;
              tr.height=160;
              tr.y=Ycoord-200;
              flower.y=Ycoord-220;
              flower.width=15;
              flower.height=30;
              flower.x=genX-32;
                
                
              treeArr[genX]=tr;
              treeArr[genX].anchor.set(1);
          
               
          
              treeArr[genX+500]=flower;
              tree.addChild(treeArr[genX]);
            tree.addChild(treeArr[genX+500]);
              treeArr[genX].x=genX;
           treeArr[genX].interactive = true;
                treeArr[genX].click = function(){
                    fallingTrees.push(treeArr[genX]);
                    fallTree();
                }
            }
      
  }
    
 
  
   
    

  function generateLTR(){
         for(var i=0;i<3;i++){
            var genX=0;
       
        
        var randY = 16*Math.round(Math.sin(rightBlock)+20)-(Math.floor(Math.random() * 10))*16;
        
        while(rightY!=randY){
            console.log("rightY=" + rightY);
            console.log("rightY=" + randY);
        genX=rightBlock;
        sand[genX] = new Array();
        rightBlock+=16;     
        let sprite=new PIXI.Sprite(PIXI.loader.resources["grass.png"].texture);
        sand[genX][rightY]=sprite;
            sand[genX][rightY].interactive = true;
        sand[genX][rightY].click = function(e) {
         sand[genX][rightY].visible=false;
 }
            
        sand[genX][rightY].x=genX;
        var rightYToAdd=rightY;       
            
        var randbool = Math.random() >= 0.9;
            
        if(rightY<randY){
          addTree(genX,rightY);
          sand[genX][rightY].y=rightY;
          if(randbool)rightY+=16;
        }
        else{
            sand[genX][rightY].y=rightY;
            rightY-=16;
        }
        
                 
        sand[genX][rightYToAdd].width=16;       
        sand[genX][rightYToAdd].height=16;
        container.addChild(sand[genX][rightYToAdd]);
            sand[genX][rightYToAdd].interactive = true;
             sand[genX][rightYToAdd].click = function(e) {
         this.visible=false;
         this.y-=64;       
 }
        
            
            
            
            
        toDelete.push(sand[genX][rightYToAdd]);
        
        var toBottomY=rightYToAdd;
       while(toBottomY<700){
           sprite = new PIXI.Sprite(PIXI.loader.resources["g.png"].texture);
            toBottomY+=16;
            console.log('randY: ' + randY);
            sand[genX][toBottomY]=sprite;
            
            sand[genX][toBottomY].x=genX;
            sand[genX][toBottomY].y=toBottomY;
            sand[genX][toBottomY].width=16;       
            sand[genX][toBottomY].height=16;
           gcontainer.addChild(sand[genX][toBottomY]);
           
        toDelete.push(sand[genX][toBottomY]);
        }
                 
        
             }
        
        
        
    }
    
    app.stage.addChild(gcontainer);
    }
    
    
  function generateRTL(){
       
        var genX=0;
      /*
      
     toDelete.forEach(function(item) {
  item.visible=false;
});
      */
         for(var i=0;i<3;i++){
             
        
        
       
       var randY = 16*Math.round(Math.sin(leftBlock)+20)-(Math.floor(Math.random() * 10))*16;
  
        
      
        
        while(leftY!=randY){
            console.log("leftY=" + leftY);
            console.log("leftY=" + leftY);
        genX=leftBlock;
        sand[genX] = new Array();
        leftBlock-=16;  
        let sprite=new PIXI.Sprite(PIXI.loader.resources["grass.png"].texture);
        
        sand[genX][leftY]=sprite;
     
        sand[genX][leftY].x=genX;
        var leftYToAdd=leftY;       
        var randbool = Math.random() >= 0.9;
       
            
        if(leftY<randY){
          sand[genX][leftY].y=leftY;
          addTree(genX,leftY);
            
          
        
          if(randbool){
              
              leftY+=16;
            
              
 
          }
        }
        else{
            sand[genX][leftY].y=leftY;
            leftY-=16;
        }
        
                 
        sand[genX][leftYToAdd].width=16;       
        sand[genX][leftYToAdd].height=16;
        container.addChild(sand[genX][leftYToAdd]);
        
        
        
        toDelete.push(sand[genX][leftYToAdd]);
        toBottom();
       
            
            function toBottom(){
                 var toBottomY=leftYToAdd;
        while(toBottomY<700){
            sprite = new PIXI.Sprite(PIXI.loader.resources["g.png"].texture);
            toBottomY+=16;
            console.log('randY: ' + randY);
            sand[genX][toBottomY]=sprite;
           
            sand[genX][toBottomY].x=genX;
            sand[genX][toBottomY].y=toBottomY;
            sand[genX][toBottomY].width=16;       
            sand[genX][toBottomY].height=16;
           container.addChild(sand[genX][toBottomY]);
           
        toDelete.push(sand[genX][toBottomY]);
        }
            }
                 
        
             }
        
        
        
    }
    
   
    
    }
    
    
  function floatGrnd(){
       
        var genX=0;
      /*
      
     toDelete.forEach(function(item) {
  item.visible=false;
});
      */
         for(var i=0;i<200;i++){
             
        genX+=16;
        sand[genX] = new Array();
        
        
       
        var randY = 256;
      
        
          
        var sandBlock = new PIXI.Sprite(PIXI.loader.resources["grass.png"].texture);
             
        sand[genX][randY]=sandBlock;
        sand[genX][randY].x=genX;
        sand[genX][randY].y=randY;
        sand[genX][randY].width=16;       
        sand[genX][randY].height=16;
        container.addChild(sand[genX][randY]);
        console.log(sand[genX][randY]);
        console.log("block = " + genX + '|' + randY);
        console.log("coords = " + sand[genX][randY].x + "|" + sand[genX][randY].y);
             console.log('gen');
       
                 
        
             }
    }
    
    
    
    function checkPhysics(arr) {
      arr[1].y+=1;
    
      for(var i=-4;i<=3;i++){
                
                try{
                
                 
                 b = new Bump(PIXI);
                 let catVsBlocks = b.hit(
  arr[1], 
  sand[arr[1].x+(i*16)][arr[1].y+16], 
  true, false, false, 
  function(collision, platform){
      
      
      //cat.y-=7;
      
     if(i==-2|i==1){
         
         arr[1].y-=4
     };
      
      return true;
      
  }
                     
                     
);
                 
                  
               //collide(cat,sand[cat.x][cat.y+64]);
           }   
      catch {
      
  }
            }
     
    
 }
    
    
    
    
    function keyboard(keyCode) {
  let key = {};
  key.code = keyCode;
  key.isDown = false;
  key.isUp = true;
  key.press = undefined;
  key.release = undefined;
  //The `downHandler`
  key.downHandler = event => {
    if (event.keyCode === key.code) {
      if (key.isUp && key.press) key.press();
      key.isDown = true;
      key.isUp = false;
    }
    event.preventDefault();
  };

  //The `upHandler`
  key.upHandler = event => {
    if (event.keyCode === key.code) {
      if (key.isDown && key.release) key.release();
      key.isDown = false;
      key.isUp = true;
    }
    event.preventDefault();
  };

  //Attach event listeners
  window.addEventListener(
    "keydown", key.downHandler.bind(key), false
  );
  window.addEventListener(
    "keyup", key.upHandler.bind(key), false
  );
  return key;
}
    
    
    let left = keyboard(37),
      up = keyboard(38),
      right = keyboard(39),
      down = keyboard(40);
    
    var cats=[];
    pers.y=0;
          
   let backCont = new PIXI.Container();
    var background = new PIXI.Sprite(PIXI.loader.resources["back.png"].texture);
    background.anchor.set(0);
    background.y=0;
    background.x=0;
    background.width=1000;
    background.height=600;
    backCont.addChild(background);
    app.stage.addChild(backCont);
    
          
    cat=new PIXI.Sprite(PIXI.loader.resources["cat.png"].texture);
    cat.anchor.set(0.5);
    
    cats[1]=new PIXI.Sprite(PIXI.loader.resources["cat2.png"].texture);
    cats[1].anchor.set(0.5);
    cats[1].y=0;
    cats[1].x=464+(16*20);
    cats[1].width=60;
    cats[1].height=50;
    container.addChild(cats[1]);
    app.stage.addChild(container);
    cats[1].interactive=true;
    
    cats[1].click = function(){
        container.x-=cats[1].x-cat.x;
        gcontainer.x-=cats[1].x-cat.x;
                    cat.x=cats[1].x;
                    cat.y=cats[1].y-=16;
                    cats[1].texture=PIXI.loader.resources["riding.png"].texture;
                    cats[1].height+=10;
                    cat.visible=false;
                    riding=true;
                    catRiding=cats[1];
                    fallTree();
                }
    
    
    checkPhysics(cats);
    
          
          
    
    
    cat.y=0;
    container.y=200;
    gcontainer.y=200;
    cat.x=464;
    var roundedcatX=464;
    console.log(cat.getGlobalPosition());
    catY=160;
    cat.width=60;
    cat.height=50;
    
    
    container.addChild(cat);
    container.addChild(tree);
    
    //container.addChild(cat);
    app.stage.addChild(container);
    
    
   
       
    generateRTL();
    generateLTR();
    
    
    
    function checkForEdges(side=""){
        
        
        
        
            
            if (side=="right"){
                
                
                
                
                if(gcontainer.x<((-1*rightBlock)+800)){
                    generateLTR();  
                }
                
               
            }
            else if (side=="left"){
                 if(gcontainer.x>((-1*leftBlock))){
                   generateRTL(); 
                }
            }
           
           
           
        
    }
    
    
    var moveRight=false;
    var moveLeft=false;
    
    right.press = () => {
        moveRight=true;
  };
    
    right.release = () =>{
      moveRight=false;  
    };
    
     left.press = () => {
        moveLeft=true;
  };
    
    left.release = () =>{
      moveLeft=false;  
    };


    app.stage.scale.set(0.8);
    //container.y=600;
    
  var sandBlock = new PIXI.Sprite(PIXI.loader.resources["s.jpg"].texture); 
  var catFalling=true;
    
    
    
 function collide() {
      for(var i=-5;i<=2;i++){
                
                try{
                
                 
                 b = new Bump(PIXI);
                 let catVsBlocks = b.hit(
  cat, 
  //sand[464][272], 
  sand[roundedcatX+(i*16)][cat.y+16], 
  true, false, false, 
  function(collision, platform){
      console.log("collide at " + i);
      console.log(collision);
      catFalling=false;
      //cat.y-=7;
      
        
         if(i==0|i==-1){
             cat.y-=2;
         }
      else{
          cat.y-=9;
      }
         
     
      
      return true;
      
  }
                     
                     
);
                 
                  
               //collide(cat,sand[cat.x][cat.y+64]);
           }   
      catch {
         console.log("block [" + roundedcatX + "]["+cat.y+"]" + "undefined");
         
  }
            }
     
    
 }
        
          
           
          
           
      
       
        

        
         
    
  app.ticker.add(function() {
      
      
          if(fall)fallTree();
      
            if(catFalling){
                cat.y+=1;
                collide();
            }
      
            
      
            checkPhysics(cats);
            
           
            
           
         

      
      
      
         

      
      
     
      
  
      
  if(moveRight){
      
      
      if(riding){
         cat.x+=16;
         cat.y=catRiding.y-16;
         roundedcatX+=16;
         catRiding.x+=16;
         collide();
          container.x-=16;
          gcontainer.x-=16;
          catRiding.scale.x=-0.3;
      }
      else{
      cat.x+=2;
      collide();
      container.x-=2;
      gcontainer.x-=2;
      }
      
      
      
      if ((cat.x%16)==0){
          console.log("rndCat++");
          roundedcatX+=16;
          if(riding){
            catFalling=false;  
          }
          else{
              catFalling=true;
          }
          
      }
     
      checkForEdges('right');
      cat.scale.x = -0.3;
      
  }
      
   if(moveLeft){
      
      
      if(riding){
         //cat.x-=4;
         cat.y=catRiding.y+16;
         roundedcatX-=16;
         catRiding.x-=16;
         collide();
          container.x+=16;
          gcontainer.x+=16;
          catRiding.scale.x=0.3;
      }
      else{
      cat.x-=2;
      collide();
      container.x+=2;
      gcontainer.x+=2;
      }
      
      
      
      if ((cat.x%16)==0){
          console.log("rndCat++");
          roundedcatX-=16;
          if(riding){
            catFalling=false;  
          }
          else{
              catFalling=true;
          }
          
      }
     
      checkForEdges('left');
      cat.scale.x = 0.3;
      
  }
      
      
       
  
  
  
   
});

    
    

}
    
    
    

    
    
    
    
    
    
    </script>
</body>
</html>