<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Игра</title>
</head>
<body>
    
    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.7.1/pixi.min.js"></script>
<script src="bump.js"></script>
<script src="circular-json.js"></script>
<script src="https://code.createjs.com/soundjs-0.6.2.min.js"></script>

<script>
    const JSON = CircularJSON;
    
  let app = new PIXI.Application({ 
    width: 800, 
    height: 600,                       
    antialias: true, 
    transparent: false, 
    resolution: 1,
    backgroundColor:0x51b1cd,
    roundPixels: true
  }
);
    
    var renderer = PIXI.autoDetectRenderer(800, 600,{backgroundColor : 0x1099bb})

//Add the canvas that Pixi automatically created for you to the HTML document
document.body.appendChild(app.view);
    
    var text = new PIXI.Text('Загрузка котанов...',{fill : '#000000', font : '48px Arial',wordWrap : true, wordWrapWidth : 800});
			text.x = 200;
            text.y=230;
			app.stage.addChild(text);
    
    

  var stepSound=createjs.Sound.registerSound("step.mp3", "step");
  console.log(stepSound);
  var treeFallSound=createjs.Sound.registerSound("treefall.mp3", "treeFall");
  console.log(treeFallSound);
  var ambientSound=createjs.Sound.registerSound("ambient.mp3", "ambient");
  console.log(ambientSound);
  var popSound=createjs.Sound.registerSound("pop.mp3", "pop");
  console.log(popSound);
    
//load an image and run the `setup` function when it's done
PIXI.loader
  .add("s.jpg")
  .add("cat.png")
  .add("grass.png")
  .add("women.png")
  .add("wood.png")
  .add("snowgrass.png")
  .add("snowtree.png")
  .add("snowtree2.png")
  .add("snowtree3.png")
  .add("snowtree4.png")  
  .add("g.png")
  .add("cursor.png")
  .add("item.png")
  .add("snowg.png")
  .add("tree.png")
  .add("tree2.png")
  .add("tree3.png")
  .add("tree4.png")
  .add("riding.png")
  .add("snowg-resource.png")
  .add("gb.png")
  .add("snowgb.png")
  .add("back.png")
  .add("flower.png")
  .add("cat2.png")
  .add("rabbit.png")
  .add("stone.png")
  .load(setup);
    
PIXI.TRANSFORM_MODE.DEFAULT = PIXI.TRANSFORM_MODE.DYNAMIC;
    



//This `setup` function will run when the image has loaded
function setup() {
    var catRiding;
    var mouseDisplacement=0;
    var riding=false;
    var fall=false;
    var fallingTrees = [];
    var jumping=false;
    var jumpDisplacement=0;
    var physics = [];
    
    
    function fallTree(){
          if(!fall)createjs.Sound.play("treeFall");
          fall=true;
          
               fallingTrees.forEach(function(item,i,arr) {
  item.rotation += 0.02;
  item.y+=0.8;
  if(item.rotation>1.2){
      delete fallingTrees[i];
      addResource(item.x,item.y-16,"wood");
      addResource(item.x-16,item.y-16,"wood");
      addResource(item.x+32,item.y-16,"wood");
      addResource(item.x+32+32,item.y-16,"wood");
      addResource(item.x+32+32+32,item.y-16,"wood");
      createjs.Sound.play("pop");
      item.visible=false;
      delete item;
      fall=false;
  }
});
       } 
    
    
    
    function physicsController(){
                
        physics.forEach(function(item,i,arr) {
          if(item.jumping)jumpRes(item);
          else if(item.falling & item.type!="res"){
              item.y+=1;
              collide(item);
          }
          else if(item.falling & item.type=="res" & item.y<item.initialY)item.y+=1;
            
          
});
    }
    
    
    
    
    
    
    var sand = new Array();
    var myStorageCounter=0;
    var leftBlock = 256;
    var leftY = 256;
    var rightY = 256;
    var rightBlock=272;
    var catY=0;
    let pers = new PIXI.Container();
    let container = new PIXI.Container();
    let tree=new PIXI.Container();
    tree.y=50;
    var treeArr=[];
    let gcontainer=new PIXI.ParticleContainer(15000,0,20000,true);
    var toDelete= [];
    var resArr=[];  
  function addTree(genX, Ycoord,biom){
      var treeChance=Math.random()>=0.9;
      if (biom=="snow"){
      treeChance=Math.random()>=0.93;  
      }
      else if(biom==undefined)biom="";
      
      var treeType=Math.random();
      if (treeChance){
                let tr;
                let flower = new PIXI.Sprite(PIXI.loader.resources["flower.png"].texture);
                
                if(treeType>=0.3 & treeType<0.5){
                    tr=new PIXI.Sprite(PIXI.loader.resources[biom+"tree.png"].texture);
                }
                else if(treeType>=0.5 & treeType<0.7){
                    tr=new PIXI.Sprite(PIXI.loader.resources[biom+"tree2.png"].texture);
                }
                else if(treeType>=0.7){
                    tr=new PIXI.Sprite(PIXI.loader.resources[biom+"tree3.png"].texture);
                }
                else{
                    tr=new PIXI.Sprite(PIXI.loader.resources[biom+"tree4.png"].texture);
                }

              Ycoord+=150;
              tr.width=100;
              tr.height=160;
              tr.y=Ycoord-200;
              flower.y=Ycoord-220;
              flower.width=15;
              flower.height=30;
              flower.x=genX-32;
                
                
              treeArr[genX]=tr;
              treeArr[genX].anchor.set(1);
          
               
          
              treeArr[genX+500]=flower;
              tree.addChild(treeArr[genX]);
            tree.addChild(treeArr[genX+500]);
              treeArr[genX].x=genX;
           treeArr[genX].interactive = true;
                treeArr[genX].click = function(){
                    fallingTrees.push(treeArr[genX]);
                    fallTree();
                }
                
                
            }
      
  }
    
 
  
 function addResource(xCoord, yCoord,type){
    var res=new PIXI.Sprite(PIXI.loader.resources[type+".png"].texture);
    //res.anchor.set(0.5);
    res.y=yCoord;
    res.x=xCoord;
    res.initialY=yCoord;
    res.width=16;
    res.height=16;
    res.jumpDisplacement=0;
    res.jumping=true;
    res.falling=false;
    res.type="res";
    res.resourceType=type;
    physics.push(res);
    resArr[xCoord]=res;
    
    container.addChild(res);
    
    app.stage.addChild(container);
    
    //jumpRes(res);      TOPHYS
 }
    
    
   
    
   
    
function collectResources(){
      b = new Bump(PIXI);
      
      
      resArr.forEach(function(item,i) {
       
        if(b.hitTestRectangle(item,cat)){
            console.log("collected");
            
            
            for(var i=1;i<=5;i++){
                try{
                    
                console.log(cat.inventory[i]);
                if(cat.inventory[i].name & cat.inventory[i].name!=item.resourceType){
                   console.log("Слот занят");
                
                }  
                else if(cat.inventory[i].name==item.resourceType){
                    console.log("else");
                    item.visible=false;
                    cat.inventory[i].name=item.resourceType;
                    cat.inventory[i].count+=1;
                    console.log(cat.inventory[i]);
                    userInterface();
                    updateInterface();
                    item.y+=600;
                    delete item; 
                    break;
                    }
                else if(!cat.inventory[i].name){
                    console.log("undef")
                    item.visible=false;
                    cat.inventory[i].name=item.resourceType;
                    cat.inventory[i].count+=1;
                    console.log(cat.inventory[i]);
                    userInterface();
                    //updateInterface();
                    item.y+=600;
                    delete item;
                    break;
                   
                }
                }
                catch(err){
                   console.log(err);
                   updateInterface();
                }
               
            }
            
           
  }
  });
                  }
    
    
function isRightClick(e) {
  return e.which === 3;
}
    


this.addEventListener('contextmenu', (e) => {
    e.preventDefault();
    console.log("RightClick");
    addBlock(e.clientX, e.clientY);
    
  });
    
this.addEventListener('mousemove', (e) => {
    container.removeChild(curs);
    cursor(e.clientX, e.clientY);
    
  });


    
    
//rightClick(this);
                  
    

 function generateLTR(biom){
      
      let grassSprite=new PIXI.Sprite(PIXI.loader.resources["grass.png"].texture);
      let groundSprite=new PIXI.Sprite(PIXI.loader.resources["g.png"].texture);
      let groundBonesSprite=new PIXI.Sprite(PIXI.loader.resources["gb.png"].texture);  
      
      
          if(biom=="snow"){
             grassSprite=new PIXI.Sprite(PIXI.loader.resources["snowgrass.png"].texture);
             groundSprite=new PIXI.Sprite(PIXI.loader.resources["snowg.png"].texture);
             groundBonesSprite=new PIXI.Sprite(PIXI.loader.resources["snowgb.png"].texture);
          }
            
            
           
      
      
         for(var i=0;i<5;i++){
            var genX=0;
             
      
     
    
       
        
        var randY = 16*Math.round(Math.sin(rightBlock)+20)-(Math.floor(Math.random() * 10))*16;
        
        while(rightY!=randY){
        genX=rightBlock;
        sand[genX] = new Array();
        rightBlock+=16;     
        let sprite=grassSprite;
            
        sand[genX][rightY]=new PIXI.Sprite(sprite.texture);
        
        
            sand[genX][rightY].interactive = true;
        sand[genX][rightY].click = function(e) {
         sand[genX][rightY].visible=false;
         createjs.Sound.play("pop");
         
 }
            
        sand[genX][rightY].x=genX;
        var rightYToAdd=rightY;       
            
        var randbool = Math.random() >= 0.9;
            
        if(rightY<randY){
          addTree(genX,rightY,biom);
          sand[genX][rightY].y=rightY;
          if(randbool)rightY+=16;
        }
        else{
            sand[genX][rightY].y=rightY;
            rightY-=16;
        }
        
                 
        sand[genX][rightYToAdd].width=16;       
        sand[genX][rightYToAdd].height=16;
        sand[genX][rightYToAdd].type=biom+"grass";
        container.addChild(sand[genX][rightYToAdd]);
            sand[genX][rightYToAdd].interactive = true;
             sand[genX][rightYToAdd].click = function(e) {
                
                console.log("rightYToAdd clicked");
                this.visible=false;
                createjs.Sound.play("pop");
                addResource(this.x,this.y,this.type);
                console.log("added resource " + this.x + "|" + this.y);
                this.y+=600;
             }
             
              sand[genX][rightYToAdd].on("mouseover", function(e){  
  console.log('Навели на блок');
  sand[this.x][this.y].tint = 0xADADC1;
  
});
            
             sand[genX][rightYToAdd].on("mouseout", function(e){  
  console.log('Убрали с блока на блок');
  sand[this.x][this.y].tint = 0xFFFFFF;
  
});
        
            
            
            
            
        toDelete.push(sand[genX][rightYToAdd]);
        
        var toBottomY=rightYToAdd;
        var toStone=0;
            
       while(toBottomY<700){
           
           if(toStone>=8){
                
                sprite = new PIXI.Sprite(PIXI.loader.resources["stone.png"].texture);
                
           }
           else{
               sprite = groundSprite;
               
               var bonesChance = Math.random() >= 0.97;
               
               if (bonesChance){
                 sprite = groundBonesSprite;  
               }
               
           }
           
           
           
            toBottomY+=16;
            sand[genX][toBottomY]= new PIXI.Sprite(sprite.texture);
            
            
           
            sand[genX][toBottomY].x=genX;
            sand[genX][toBottomY].y=toBottomY;
            sand[genX][toBottomY].width=16;       
            sand[genX][toBottomY].height=16;
           sand[genX][toBottomY].type=biom+"g";
           
          
           
           container.addChild(sand[genX][toBottomY]);
            sand[genX][toBottomY].interactive = true;
            sand[genX][toBottomY].click = function(e) {
                
               console.log("toBottomY clicked");
                this.visible=false;
                createjs.Sound.play("pop");
                addResource(this.x,this.y,this.type);
                this.y+=600;
             }
           toStone+=1;
           
           sand[genX][toBottomY].on("mouseover", function(e){  
  console.log('Навели на блок');
  sand[this.x][this.y].tint = 0xADADC1;
  
});
            
             sand[genX][toBottomY].on("mouseout", function(e){  
  console.log('Убрали с блока на блок');
  sand[this.x][this.y].tint = 0xFFFFFF;
  
});
           
        toDelete.push(sand[genX][toBottomY]);
        }
                 
        
             }
        
        
        
    }
    
    app.stage.addChild(gcontainer);
    }
    
    
 function generateRTL(biom){
    
      let grassSprite=new PIXI.Sprite(PIXI.loader.resources["grass.png"].texture);
      let groundSprite=new PIXI.Sprite(PIXI.loader.resources["g.png"].texture);
      let groundBonesSprite=new PIXI.Sprite(PIXI.loader.resources["gb.png"].texture);  
      
      
          if(biom=="snow"){
             grassSprite=new PIXI.Sprite(PIXI.loader.resources["snowgrass.png"].texture);
             groundSprite=new PIXI.Sprite(PIXI.loader.resources["snowg.png"].texture);
             groundBonesSprite=new PIXI.Sprite(PIXI.loader.resources["snowgb.png"].texture);
          }
            
            
           
      
      
         for(var i=0;i<5;i++){
            var genX=0;
             
      
     
    
       
        
        var randY = 16*Math.round(Math.sin(rightBlock)+20)-(Math.floor(Math.random() * 10))*16;
        
        while(leftY!=randY){
        genX=leftBlock;
        sand[genX] = new Array();
        leftBlock-=16;     
        let sprite=grassSprite;
            
        sand[genX][leftY]=new PIXI.Sprite(sprite.texture);
        
        
           
            
        sand[genX][leftY].x=genX;
        var leftYToAdd=leftY;       
            
        var randbool = Math.random() >= 0.9;
            
        if(leftY<randY){
          addTree(genX,leftY,biom);
          sand[genX][leftY].y=leftY;
          if(randbool)leftY+=16;
        }
        else{
            sand[genX][leftY].y=leftY;
            leftY-=16;
        }
        
                 
        sand[genX][leftYToAdd].width=16;       
        sand[genX][leftYToAdd].height=16;
        sand[genX][leftYToAdd].type=biom+"grass";
            
        container.addChild(sand[genX][leftYToAdd]);
            sand[genX][leftYToAdd].interactive = true;
            sand[genX][leftYToAdd].click = function(e) {
                
                console.log("leftYToAdd clicked");
                this.visible=false;
                createjs.Sound.play("pop");
                addResource(this.x,this.y,this.type);
                console.log("added resource " + this.x + "|" + this.y);
                this.y+=600;
             }
            
              sand[genX][leftYToAdd].on("mouseover", function(e){  
  console.log('Навели на блок');
  sand[this.x][this.y].tint = 0xffd187;
  
});
            
             sand[genX][leftYToAdd].on("mouseout", function(e){  
  console.log('Убрали с блока на блок');
  sand[this.x][this.y].tint = 0xFFFFFF;
  
});
            
            
            
            
            
            
        toDelete.push(sand[genX][leftYToAdd]);
        
        var toBottomY=leftYToAdd;
        var toStone=0;
            
       while(toBottomY<700){
           
           if(toStone>=8){
                
                sprite = new PIXI.Sprite(PIXI.loader.resources["stone.png"].texture);
                
           }
           else{
               sprite = groundSprite;
               
               var bonesChance = Math.random() >= 0.97;
               
               if (bonesChance){
                 sprite = groundBonesSprite;  
               }
               
           }
           
           
           
            toBottomY+=16;
            sand[genX][toBottomY]= new PIXI.Sprite(sprite.texture);
            
            
           
            sand[genX][toBottomY].x=genX;
            sand[genX][toBottomY].y=toBottomY;
            sand[genX][toBottomY].width=16;       
            sand[genX][toBottomY].height=16;
            sand[genX][toBottomY].type=biom+"g";
           
           
          
           
           container.addChild(sand[genX][toBottomY]);
            sand[genX][toBottomY].interactive = true;
            sand[genX][toBottomY].click = function(e) {
                
               console.log("toBottomY clicked");
                this.visible=false;
                createjs.Sound.play("pop");
                addResource(this.x,this.y,this.type);
                
                this.y+=600;
             }
            
            
             sand[genX][toBottomY].on("mouseover", function(e){  
  console.log('Навели на блок');
  sand[this.x][this.y].tint = 0xADADC1;
  
});
            
             sand[genX][toBottomY].on("mouseout", function(e){  
  console.log('Убрали с блока на блок');
  sand[this.x][this.y].tint = 0xFFFFFF;
  
});
            
            
           toStone+=1;
           
        toDelete.push(sand[genX][toBottomY]);
        }
                 
        
             }
        
        
        
    }
    
  //  app.stage.addChild(gcontainer);
    }
    
    
  function floatGrnd(){
       
        var genX=0;
      /*
      
     toDelete.forEach(function(item) {
  item.visible=false;
});
      */
         for(var i=0;i<200;i++){
             
        genX+=16;
        sand[genX] = new Array();
        
        
       
        var randY = 256;
             
        sand[genX][randY]=sandBlock;
        sand[genX][randY].x=genX;
        sand[genX][randY].y=randY;
        sand[genX][randY].width=16;       
        sand[genX][randY].height=16;
        container.addChild(sand[genX][randY]);
        console.log(sand[genX][randY]);
        console.log("block = " + genX + '|' + randY);
        console.log("coords = " + sand[genX][randY].x + "|" + sand[genX][randY].y);
             console.log('gen');
       
                 
        
             }
    }
    
  var curs=undefined;
    
  function cursor(xC,yC){
      var cattX=Math.floor(cat.x/16)*16;
      var rnX=(Math.floor(xC/16)*16)+(cattX-16*30);
      var rnY=(Math.floor(yC/16)*16)-208;
        curs = new PIXI.Sprite(PIXI.loader.resources["cursor.png"].texture);
        curs.x=rnX;
        curs.y=rnY;
        curs.width=16;
        curs.height=16;
        container.addChild(curs);
  }
    
  function addBlock(xC, yC){
      
      //if (cat.blocks<=0)return;
      var blockType=cat.inventory[cat.selectedItem].name;
      
      
      var cattX=Math.floor(cat.x/16)*16;
      var rnX=(Math.floor(xC/16)*16)+(cattX-16*30);
      var rnY=(Math.floor(yC/16)*16)-208;
      console.log(sand[rnX]);
      if(sand[rnX][rnY]){
         sand[rnX][rnY].visible=false;
         delete sand[rnX][rnY];
      }
      
      
      if(sand[rnX]){
         sand[rnX][rnY]=new PIXI.Sprite(PIXI.loader.resources[blockType + ".png"].texture); 
      }
      else{
          sand[rnX] = new Array(); 
          sand[rnX][rnY]=new PIXI.Sprite(PIXI.loader.resources[blockType + ".png"].texture); 
      }
      
      
        
         sand[rnX][rnY].interactive = true;
      
         sand[rnX][rnY].click = function(e) {
         addResource(this.x,this.y,blockType);
          
         sand[rnX][rnY].y+=1000;
         sand[rnX][rnY].visible=false;
         createjs.Sound.play("pop");
         
         delete sand[rnX][rnY];
         }
            
        sand[rnX][rnY].x=rnX;
        sand[rnX][rnY].y=rnY;
                 
         sand[rnX][rnY].width=16;       
         sand[rnX][rnY].height=16;
        container.addChild(sand[rnX][rnY]);
      
      cat.blocks-=1;
        
  }
   
  function addCat(obType){
       
        var n=3+cats.length+Math.floor(Math.random()*5);
        
        for(var i=cats.length+1;i<n;i++){
           
    cats[i]=new PIXI.Sprite(PIXI.loader.resources[obType + ".png"].texture);
    cats[i].anchor.set(0.5);
    cats[i].y=0;
    cats[i].x=cat.x+(16*(Math.round(Math.random()*20)));
    cats[i].rndx=cats[i].x;
    cats[i].width=60;
    cats[i].height=50;
    container.addChild(cats[i]);
    app.stage.addChild(container);
    cats[i].interactive=true;
    cats[i].falling=true;
    cats[i].type="animal";
    physics.push(cats[i]);
    

    /*
    cats[1].click = function(){
        container.x-=cats[1].x-cat.x;
        gcontainer.x-=cats[1].x-cat.x;
                    cat.x=cats[1].x;
                    cat.y=cats[1].y-=16;
                    cats[1].texture=PIXI.loader.resources["riding.png"].texture;
                    cats[1].height+=10;
                    cat.visible=false;
                    riding=true;
                    catRiding=cats[1];
                    //fallTree();
                } 
                
                  */
        }
        
    
    }
      
    
    
    
  function keyboard(keyCode) {
  let key = {};
  key.code = keyCode;
  key.isDown = false;
  key.isUp = true;
  key.press = undefined;
  key.release = undefined;
  //The `downHandler`
  key.downHandler = event => {
    if (event.keyCode === key.code) {
      if (key.isUp && key.press) key.press();
      key.isDown = true;
      key.isUp = false;
    }
    event.preventDefault();
  };

  //The `upHandler`
  key.upHandler = event => {
    if (event.keyCode === key.code) {
      if (key.isDown && key.release) key.release();
      key.isDown = false;
      key.isUp = true;
    }
    event.preventDefault();
  };

  //Attach event listeners
  window.addEventListener(
    "keydown", key.downHandler.bind(key), false
  );
  window.addEventListener(
    "keyup", key.upHandler.bind(key), false
  );
  return key;
}
    
    
    let left = keyboard(37),
      up = keyboard(38),
      right = keyboard(39),
      one = keyboard(49),
      two = keyboard(50),
      three = keyboard(51),
      four = keyboard(52),
      five = keyboard(53),
      down = keyboard(40);
    
    var cats=[];
    pers.y=0;
          
    let backCont = new PIXI.Container();
    var background = new PIXI.Sprite(PIXI.loader.resources["back.png"].texture);
    background.anchor.set(0);
    background.y=0;
    background.x=0;
    background.width=1000;
    background.height=600;
    backCont.addChild(background);
    app.stage.addChild(backCont);
    
          
    cat=new PIXI.Sprite(PIXI.loader.resources["cat.png"].texture);
    cat.anchor.set(0.5);
    cat.y=0;
    cat.blocks=0;
    cat.inventory=[];
    container.y=200;
    gcontainer.y=200;
    cat.x=464;
    cat.rndx=464;
    catY=160;
    cat.width=60;
    cat.selectedItem=0;
    cat.height=50;
    cat.type="player";
    for(var i=1;i<=5;i++){
        cat.inventory[i] = new Object();
        cat.inventory[i].count=0;
    }
    
    
    cat.ableToMoveLeft=true;
    cat.ableToMoveRight=true;
    physics.push(cat);
    
    
    container.addChild(cat);
    container.addChild(tree);
    
    //container.addChild(cat);
    app.stage.addChild(container);
    
    
   
    addCat("rabbit");
    
    generateRTL();
    generateLTR("snow");
    addCat("cat2");
  
    
    
    
    function checkForEdges(side=""){
        
        
        
        
            
            if (side=="right"){
                
                
                
                
                if(gcontainer.x<((-1*rightBlock)+800)){
                    generateLTR();  
                }
                
               
            }
            else if (side=="left"){
                 if(gcontainer.x>((-1*leftBlock))){
                   generateRTL(); 
                }
            }
           
           
           
        
    }
    
    
    var moveRight=false;
    var moveLeft=false;
    
    right.press = () => {
        moveRight=true;
        cat.falling=true;
    };
    
    right.release = () =>{
      moveRight=false;  
      cat.falling=true;
    };
    
    one.press = () => {
        cat.selectedItem=1;
        console.log("cat.selected=" + cat.selectedItem);
    };
    
    
    two.press = () => {
        cat.selectedItem=2;
        console.log("cat.selected=" + cat.selectedItem);
    };
    
    three.press = () => {
        cat.selectedItem=3;
        console.log("cat.selected=" + cat.selectedItem);
    };
    
    four.press = () => {
        cat.selectedItem=4;
        console.log("cat.selected=" + cat.selectedItem);
    };
    
    five.press = () => {
        cat.selectedItem=5;
        console.log("cat.selected=" + cat.selectedItem);
    };
    
    
     left.press = () => {
        moveLeft=true;
        cat.falling=true;
  };
    
    left.release = () =>{
      moveLeft=false;  
    };
        
        up.release = () => {
        if(!jumping){
          jumping=true;
        jump();  
        }
        
  };


    app.stage.scale.set(1);
    //container.y=600;
    
  var sandBlock = new PIXI.Sprite(PIXI.loader.resources["s.jpg"].texture); 
  cat.falling=true;
        
        
function jump(){
        
        cat.falling=false;
    
        if(jumping){
            cat.y-=(2+jumpDisplacement/2);
            jumpDisplacement+=2;
        }
      
        
        if(jumpDisplacement>15){
            jumping=false;
            cat.falling=true;
            jumpDisplacement=0;
        }
    }
        
        
function jumpRes(res){
        
        res.falling=false;
    
        if(res.jumping){
            res.y-=(2+res.jumpDisplacement/2);
            res.jumpDisplacement+=2;
        }
      
        
        if(res.jumpDisplacement>15){
            res.jumping=false;
            res.falling=true;
            res.jumpDisplacement=0;
        }
    }
    
    
    
 function collide(obj) {
     
     try{
         
     var collideLeft=sand[obj.rndx-16][obj.y];
     var leftWall=sand[obj.rndx-16][obj.y-32];
         
     var collideRight=sand[obj.rndx+16][obj.y];
     var rightWall=sand[obj.rndx+16][obj.y-32];   
         
     var collideUp=sand[obj.rndx][obj.y-16];
     var collideBottom=sand[obj.rndx][obj.y+16]; 
     }
     catch{
         
 }
     
     
     if(!collideBottom)obj.falling=true;
    
     if (leftWall){
         console.log("leftwall");
         //leftWall.tint=0xC5F3D4;
         obj.ableToMoveLeft=false;
         //mouseDisplacement+=2;
         obj.x+=2;
         obj.y-=2;
         if (obj.type=="player")container.x-=2;
         else if(obj.type=="animal"){
             if(obj.direction==0)obj.direction=1;
             else obj.direction=0;
         }
         
         return;
     }
     
     if (rightWall){
         console.log("rightWall");
         //rightWall.tint=0xC5F3D4;
         obj.ableToMoveRight=false;
         obj.x-=2;
         obj.y-=2;
         if (obj.type=="player")container.x+=2;
          else if(obj.type=="animal"){
             if(obj.direction==0)obj.direction=1;
             else obj.direction=0;
         }
         return;
     }
     
     
     
     
     b = new Bump(PIXI);
     
     var props = new createjs.PlayPropsConfig().set({interrupt: createjs.Sound.INTERRUPT_ANY, loop: 0, volume: 0.2});
     
     if (collideLeft)
     {
         let cl=b.hit(cat, collideLeft);
         if (cl)
         {
          if(obj.type=="animal")obj.y-=20;
          else obj.y-=16;
          console.log("=======LEFT======");
          obj.falling=false;
          createjs.Sound.play("step",props);
         }
     }
     
     if (collideRight)
     {
         let cr=b.hit(obj, collideRight);
         if (cr){
            if(obj.type=="animal")obj.y-=20;
            else obj.y-=16;
            console.log("=======RIGHT======");
            obj.falling=false;
            
            createjs.Sound.play("step",props);
         }
     }
     if (collideUp)
     {
         let cu=b.hit(obj, collideUp, false);
     }
     if (collideBottom)
     {  
         let cb=b.hit(obj, collideBottom, true);
         if (cb){
             
             obj.falling=false;
             //if(obj.type=="player")obj.y-=10;
             //if(obj.type=="animal" & obj.moving==true & obj.falling==true)obj.y-=5;
            
             createjs.Sound.play("step",props);
             console.log("=====BOTTOM=====");
             if(collideBottom.type=="snowgrass")console.log("Стоим на холодном блоке.");
         }
     }
         
       try{
        

        console.log("cl " +cl);
        console.log("cr " +cr);
        console.log("cu " +cu);
        console.log("cb " +cb);
           
       }  
     catch{
         
 }
         
         
        
     
     
     
     /*
      for(var i=-3;i<=2;i++){
                
                try{
                
                 
                 b = new Bump(PIXI);
                 let catVsBlocks = b.hit(
  cat, 
  //sand[464][272], 
  sand[roundedcatX+(i*16)][cat.y+16], 
  true, false, false, 
  function(collision, platform){
      console.log("collide at " + i);
      console.log(collision);
      catFalling=false;
      //cat.y-=7;
      
        
       
          cat.y-=9;
      
         
     
      
      return true;
      
  }
                     
                     
);
                 
                  
               //collide(cat,sand[cat.x][cat.y+64]);
           }   
      catch {
         console.log("block [" + roundedcatX + "]["+cat.y+"]" + "undefined");
         
  }
            }
            
            
*/
     
  
 }
        
 function randomWalk(obj) {
  
     
    if(obj.secondsToGo==undefined){
              obj.secondsToGo=1*(Math.floor(Math.random()*5)*100);
              obj.direction=(Math.random()>0.5);
          }
        else if(obj.secondsToGo){
            if (obj.secondsToGo>1){
                if(obj.direction){
                    obj.x+=0.8;
                    obj.scale.x=-0.3;
                }
                else{
                    obj.x-=0.8;
                    obj.scale.x=0.3;
                }
                
            
            obj.rndx=Math.floor((obj.x/16))*16;
            obj.secondsToGo-=1;
            //console.log(obj.secondsToGo);
            collide(obj);
            }
            else{
                //obj.moving=false;
                obj.direction=(Math.random()>0.5);
                obj.secondsToGo=1*(Math.floor(Math.random()*5)*200)+500;
            }
        } 
 }    
           
          
           
 var ambientPlaying=false;
 var interface = [];    
     
     
function userInterface(){
    for(var i=1;i<=5;i++){
        interface[i] = new PIXI.Sprite(PIXI.loader.resources["item.png"].texture); 
        interface[i].width=40;
        interface[i].height=40;
        interface[i].x=280+i*45;
        interface[i].y=540;
        app.stage.addChild(interface[i]);  
    }
    
}
     
function updateInterface(){
    
    var inv=[];
    for(var i=1;i<=5;i++){
        if(cat.inventory[i].name){
            inv[i]=new PIXI.Sprite(PIXI.loader.resources[cat.inventory[i].name+".png"].texture);
            inv[i].width=20;
            inv[i].height=20;
            inv[i].x=interface[i].x+10;
            inv[i].y=interface[i].y+5;
            app.stage.addChild(inv[i]); 
            var text = new PIXI.Text(cat.inventory[i].count,{fill : '#000000', font : '12px Arial',wordWrap : true, wordWrapWidth : 800});
			text.x = inv[i].x+2;
            text.y=inv[i].y+15;
			app.stage.addChild(text);
            
        }
    }
    
    
     //var stringJSON=JSON.stringify(sand);
   }
         
       
       

function playAmbient(){
      if(!ambientPlaying){
         console.log("playambient");
         var ambientProps = new createjs.PlayPropsConfig().set({interrupt: createjs.Sound.INTERRUPT_ANY, loop: -1, volume: 0.8});
         if(createjs.Sound.play("ambient",ambientProps)) ambientPlaying=true; 
        
      }
     
  }
         

     
    
userInterface();
     
  app.ticker.add(function() {
     
       
       /*
               cats.forEach(function(item,i,arr) {
                   //randomWalk(item);
});
*/
    
      
      
          cat.rndx=Math.floor((cat.x/16))*16;
          if(fall)fallTree();
      
          physicsController();
          
      
           
      
            if(jumping)jump();
      

      
  if(moveRight){
      
     if(!ambientPlaying)playAmbient();
      
      
      if(riding){
         cat.x+=16;
         cat.y=catRiding.y-16;
         //cats[1].falling=true;
         cat.rndx+=16;
         catRiding.x+=16;
         collide(cat);
          container.x-=16;
          gcontainer.x-=16;
          catRiding.scale.x=-0.3;
      }
      else{
       if(cat.ableToMoveRight){
            cat.x+=2;
            container.x-=2;
            gcontainer.x-=2;
            cat.ableToMoveLeft=true;
        }
      }
      
      
      
      if ((cat.x%16)==0){
          collectResources();
          collide(cat);
          mouseDisplacement+=16;
          
      }
     
      checkForEdges('right');
      cat.scale.x = -0.3;
      
  }
      
     
      
   if(moveLeft){
 
     
      if(!ambientPlaying)playAmbient();
       
      if(riding){
         //cat.x-=4;
         cat.y=catRiding.y+16;
         cat.rndx-=16;
         catRiding.x-=16;
         collide(cat);
          container.x+=16;
          gcontainer.x+=16;
          catRiding.scale.x=0.3;
      }
      else{
        if(cat.ableToMoveLeft){
            cat.x-=2;
            container.x+=2;
            gcontainer.x+=2;
            cat.ableToMoveRight=true;
        }
      
      }
      
      
      
      if ((cat.x%16)==0){
          collectResources();
          collide(cat);
          mouseDisplacement-=16;
          
      }
     
      checkForEdges('left');
      cat.scale.x = 0.3;
      
  }

});

}
    

    

    
    
    
    
    
    
    </script>
</body>
</html>